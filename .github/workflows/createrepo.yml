name: "Create Repository via IssueOps"
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

jobs:
  validate-request:
    runs-on: ubuntu-latest
    if: ${{ contains(join(github.event.issue.labels.*.name, ','), 'createrepo') }}
    steps:
      - name: Validate issue form inputs
        uses: actions/github-script@v6
        with:
          script: |
            const body = context.payload.issue.body || '';
            // try to extract "Repository name" from the issue form body
            const match = body.match(/Repository name:\s*(.+)/i);
            if (!match || !match[1].trim()) {
              throw new Error('Missing required repository name field');
            }

  approve-request:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'issue_comment' && github.event.comment.body == '/approve' && contains(join(github.event.issue.labels.*.name, ','), 'createrepo') }}
    steps:
      - name: Approve and create repository
        uses: actions/github-script@v6
        with:
          script: |
            // get repo name from title "Create Repo: {repo-name}" or fallback to form body
            const title = context.payload.issue.title || '';
            let repoName = title.replace(/^Create Repo:\s*/i, '').trim();

            if (!repoName) {
              const body = context.payload.issue.body || '';
              const match = body.match(/Repository name:\s*(.+)/i);
              repoName = match ? match[1].trim() : '';
            }

            if (!repoName) {
              throw new Error('Repository name not found; cannot create repo');
            }

            // create repository in org (requires token with permissions)
            await github.rest.repos.createInOrg({
              org: context.repo.owner,
              name: repoName,
              private: true
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `Repository '${repoName}' has been created successfully.`
            });